Here is the complete architectural summary for the Î¼BITz clock system, capturing the "Parallel Clock" design using the 24.576 MHz oscillator.

---

# Homebrew Z80 Clock Distribution Architecture

## 1. Design Overview

This architecture uses a single high-speed master oscillator (**24.576 MHz**) to drive the entire system. The clock signal is split at the source ("Parallel Distribution"):

1. **Path A (Logic):** Feeds a hardware divider (74HC4040) to generate fixed, 50% duty cycle clocks for the Z80 CPU and peripherals.
    
2. **Path B (Bridge):** Feeds the ATmega328P directly, utilizing the AVR's internal prescaler to run at a safe 12.288 MHz while retaining the ability to "Turbo" to 24.576 MHz via software.
    

## 2. Hardware Schematic & Netlist

### Component 1: Master Oscillator

- **Part:** 24.576 MHz "Can" Oscillator (Socketed).
    
- **VCC:** 5V.
    
- **Output:** Connected to **Two** locations:
    
    1. ATmega328P Pin 9 (XTAL1).
        
    2. 74HC4040 Pin 10 (CLK).
        

### Component 2: Frequency Divider

- **Part:** 74HC4040 (12-Stage Binary Ripple Counter).
    
- **Input (Pin 10):** 24.576 MHz from Oscillator.
    
- **Outputs:**
    

|**4040 Pin**|**Output**|**Divisor**|**Frequency**|**Destination**|**Notes**|
|---|---|---|---|---|---|
|**Pin 9**|Q0|$\div 2$|12.288 MHz|_Unused_|(Available on header for testing)|
|**Pin 7**|Q1|$\div 4$|**6.144 MHz**|**Z80, SIO, CTC**|Perfect 50% Duty Cycle. Safe for NMOS.|
|**Pin 6**|Q2|$\div 8$|**3.072 MHz**|**SN76489**|Sound Chip. (Requires pitch correction).|

### Component 3: ATmega328P "Smart Bridge"

- **Input (Pin 9):** 24.576 MHz direct from Oscillator.
    
- **Pin 10 (XTAL2):** **Disconnected** (Floating).
    
- **Operation:** Acts as an SPI bridge and I/O offloader.
    
- **Speed:** Selectable 12.288 MHz (Standard) or 24.576 MHz (Turbo).
    

---

## 3. Software Configuration

### A. ATmega Fuses

You must set the fuses to treat the clock as an External Clock source and enable the safety divider at boot.

- **Low Fuse Byte:** `0x60` (Check specific calculator for your BOD settings).
    
    - **CKSEL[3:0]:** `0000` (External Clock).
        
    - **CKDIV8:** `0` (Programmed/Enabled). _Critical: This forces the chip to boot at ~3 MHz._
        

### B. ATmega Initialization Code

In your `setup()` function, you must reconfigure the prescaler to speed up the chip to 12.288 MHz.

C++

```
#include <avr/power.h>

// Define system clock for delay calculations (Safe Mode)
#define F_CPU 12288000UL 

void setup() {
    // 1. Chip boots at 3.072 MHz (24.576 / 8) due to CKDIV8 fuse.
    
    // 2. Disable Interrupts during clock change
    noInterrupts();
    
    // 3. Enable Prescaler Change
    CLKPR = (1 << CLKPCE);
    
    // 4. Set Prescaler to Divide-by-2 (0001)
    //    Target: 24.576 MHz / 2 = 12.288 MHz
    CLKPR = (1 << CLKPS0); 
    
    interrupts();
    
    // ... Rest of initialization
}
```

### C. Z80 Sound Driver (Pitch Correction)

Since the SN76489 is running at 3.072 MHz instead of the NTSC standard 3.579 MHz, audio pitches will be flat. The Z80 software must compensate.

- **Correction Factor:** $3.579545 / 3.072 \approx \mathbf{1.1652}$
    
- **Formula:** `Register_Value = Target_Frequency_Register * 1.165`
    

---

## 4. System Frequency Map

|**Subsystem**|**Frequency**|**Derivation**|**Notes**|
|---|---|---|---|
|**ATmega Core**|**12.288 MHz**|$24.576 / 2$|Configured via `CLKPR`. Safe & Stable.|
|**Z80 CPU**|**6.144 MHz**|$24.576 / 4$|$\sim$2% overclock from 6 MHz.|
|**Z80 UART**|**6.144 MHz**|$24.576 / 4$|Allows 57,600 baud (Divisor 10).|
|**Sound**|**3.072 MHz**|$24.576 / 8$|Flat pitch, 50% duty cycle.|
|**SD Card SPI**|**6.144 MHz**|$F_{CPU} / 2$|Max SPI speed in Safe Mode.|

## 5. Benefits of this Architecture

1. **Decoupled Stability:** The Z80 clock is generated by hardware logic. If the ATmega crashes or resets, the Z80 clock continues uninterrupted.
    
2. **Safety:** The ATmega runs within its datasheet limits (12 MHz @ 5V).
    
3. **NMOS Compatibility:** The 74HC4040 provides a clean 50% duty cycle square wave, essential for the vintage Sharp LH0080B CPU.
    
4. **Overclock Ready:** If you need more processing power for USB HID, you can change one line of code (`CLKPR=0`) to run the ATmega at 24.576 MHz without touching a soldering iron.